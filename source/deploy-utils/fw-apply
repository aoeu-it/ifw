#!/bin/bash

# This bash script ensures that the previous chain is removed
# and the new chain is present. A chain file is a file
# containing iptable rules like (generated by to_iptables 
# tool):
#  - iptables -I CHAIN_NAME -s 172...
#  - etc.
#
# FIXME: First time it will complain because the previous CHAIN
# is not present yet.
#
# Filename of chain file is:
# path/to/chain_dir/:
#  file: arbritary_name01-CHAIN.rules
#  file: arbritary_name02-CHAIN.rules

for PROG in iptables ip6tables
do
  if [ $( which $PROG ) == '' ]
  then
    echo "missing dependency: iptables"
  fi
done

# Input validation
if [[ "$#" -ne 1 ]]
then
  echo "$0 path/to/chain-dir"
  exit 1
fi

if [[ ! -d "$1" ]]
then
  echo "$1 does not exist."
  exit 1
fi

SCRATCH_DIR=$( mktemp -d )
IPTABLES_SAVE_PATH="/etc/sysconfig/iptables"

# ipv6 support
# TODO

# Get CHAIN name from filename.
CHAINDIR=$1
CHAINS=$( ls "$CHAINDIR" | grep -o -E '[A-Z]+\.rules$' | grep -E -o '^+[A-Z]+' | sort | uniq )

echo "$CHAINS" | while read CHAIN
do
  # Move previous CHAIN aside.
  iptables -E 'IN_'$CHAIN 'IN_'$CHAIN'_TRASH'
  iptables -E 'OUT_'$CHAIN 'OUT_'$CHAIN'_TRASH'

  # Insert new chain above previous chain.
  # merge all files that have the same chain name.
  CHAIN_FILES=$(ls "$CHAINDIR" | grep -E "$CHAIN\.rules$")
  echo "$CHAIN_FILES" | while read CHAIN_FILE
  do
     touch "$SCRATCH_DIR/$CHAIN.rules"
     cat "$CHAINDIR/$CHAIN_FILE" >> "$SCRATCH_DIR/$CHAIN.rules"
  done

  # Remove duplicate rules and execute content.
  # Ensure that CHAIN create rules are executed first.
  cat "$SCRATCH_DIR/$CHAIN.rules" | grep 'iptables -N' | sort | uniq | bash
  cat "$SCRATCH_DIR/$CHAIN.rules" | grep 'ESTABLISHED' | sort | uniq | bash
  cat "$SCRATCH_DIR/$CHAIN.rules" | grep -v 'ESTABLISHED' | grep -v 'iptables -N' | sort -r | uniq | bash

  # Remove previous chain IN_CHAINNAME_TRASH and OUT_CHAINNAME_TRASH.
  for I in IN OUT
  do
    while true
    do
      iptables -D $I'_'$CHAIN'_TRASH' 1 > /dev/null 2>&1
      if [[ $? -ne 0 ]]
      then
        break
      fi
    done

    iptables -D $I'PUT' -j $I'_'$CHAIN'_TRASH'
    iptables -F $I'_'$CHAIN'_TRASH'
    iptables -X $I'_'$CHAIN'_TRASH'
  done
done

rm -rf $SCRATCH_DIR

# Make iptables persistant if save-file is present.
if [[ -f "$IPTABLES_SAVE_PATH" ]]
then
  iptables-save > "$IPTABLES_SAVE_PATH"
fi
